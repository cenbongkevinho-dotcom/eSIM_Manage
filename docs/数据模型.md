# eSIM_Manage 核心数据模型（初版）

版本：v0.1  
最后更新：2025-10-29

## 1. 实体与关键字段

### Operator（运营商）

- id（UUID）
- name（唯一）
- smdpPlusAddress（可空，Consumer 场景）
- smdsAddress（可空）
- certificateRef（Vault/HSM 引用）
- regions（列表）
- status（active/inactive）

### Master Data 通用字段与策略（新增）

- 通用字段（适用于 Customer/Supplier/Contact 等主数据实体）：
  - id（UUID），createdAt/updatedAt（ISO8601），createdBy/updatedBy（可选）。
  - version（整数，默认从 1 开始，每次业务性变更递增）。
  - isDeleted（布尔，软删除标记）；deletedAt（时间戳，可选）。
  - validFrom/validTo（可选，用于生效期管理）。
  - externalRefs（Map<string,string>，用于外部系统 ID 与参考码对齐）。
- 软删除策略：
  - 默认不物理删除记录，标记 isDeleted=true 并记录 deletedAt；对外列表接口默认过滤 isDeleted=true。
  - 仅在审计与强合规场景需要时保留物理删除流程（需安全审核与高权限）。
- 版本化策略：
  - 每次变更递增 version，并在审计日志中记录变更差异（diff）。
  - 对外 API 提供 If-Match/ETag 或 version 字段以实现并发控制（乐观锁）。
- 去重与规范化键：
  - 规范化规则：
    - name：去除前后空格、统一大小写（NameCase）、移除多余空白。
    - email：小写、去除别名（+ 后缀）可选。
    - phone：只保留数字与 '+'，统一国家码格式。
    - address：标准化国家/省/市/邮编字典，空格/拼写归一化。
  - 哈希键：
    - 使用规范化后的字段组合生成去重哈希（如 supplier: name|country；customer: name|region；contact: email|phone）。
    - 哈希算法建议：SHA-256；存储字段：dedupeKey。
  - 去重策略：
    - 新增时检测同租户下 dedupeKey 是否存在；存在则按配置进行合并或提示冲突。
    - 合并时保留来源与时间戳，记录归并日志，支持回滚（需管理员权限）。
- 索引与约束（补充）：
  - 唯一索引：entity(id)、ExternalCrmBinding(entityType,entityId,externalSystem)、去重 dedupeKey（按租户）。
  - 组合索引：Contact(entityType,entityId,isPrimary)、Supplier(country,status)、Customer(region,status)。
- slaTargets（JSON：成功率、延迟、库存阈值）

索引：name 唯一；regions GIN；status 普通索引。

### ProfileType/Inventory（Profile 类型与库存）

- id（UUID）
- operatorId（FK）
- name / region / validityDays / capacityMb / cost
- availableCount / reservedCount / totalCount
- status（available/low/out）

索引：operatorId；status；（region, validityDays）复合。

### ActivationCode（激活码）

- id（UUID）
- code（LPA 字符串：LPA:1$addr$matchingId$opts）
- qrcodeUrl（S3/OSS 路径）
- operatorId（FK）/ planId（FK）/ customerId（FK 可空）
- status（created/assigned/used/expired/void）
- expireAt（datetime）
- createdAt / usedAt

唯一约束：code 唯一。索引：status；expireAt。

### Subscription（订阅）

- id（UUID）
- eid / iccid / imsi / msisdn（敏感字段加密）
- activationCodeId（FK 可空）
- planId（FK）/ customerId（FK）/ operatorId（FK）
- status（created/downloaded/installed/enabled/disabled/deleted/failed）
- eventsCount / lastEventAt

索引：eid、iccid 唯一；status。

### Customer（客户）

- id（UUID）
- type（B2B/B2C）
- name / contactEmail / kycRef
- billingAccountId（FK）
- orgHierarchy（JSON：企业/部门/项目）

索引：type；name；billingAccountId。

### Supplier（供应商）

- id（UUID）
- type（carrier/reseller/vendor）
- name / regions（列表） / contactEmail / kycRef
- billingAccountId（FK 可空）
- status（active/inactive）
- slaTargets（JSON：SLA 指标）
- metadata（JSON）

索引：type；name；status；regions GIN；billingAccountId。

### Contact（联系人）

- id（UUID）
- entityType（customer/supplier）
- entityId（FK：指向 Customer 或 Supplier）
- role（billing/technical/sales/support/admin 等）
- name / email / phone / wechat / whatsapp / title / department
- preferences（JSON：通知渠道、语言、可联系时间）
- isPrimary（bool）
- status（active/inactive）

索引：entityType+entityId；role；email；isPrimary；status。

### ExternalCrmBinding（外部 CRM 绑定）

- id（UUID）
- system（salesforce/hubspot/zoho/other）
- entityType（customer/supplier/contact）
- entityId（本地实体 ID）
- externalId（外部系统对象 ID）
- syncMode（one_way/two_way）
- conflictPolicy（platform_first/external_first/field_level）
- fieldMappings（JSON：字段映射快照）
- lastSyncedAt / createdAt
- status（active/inactive）

约束：

- 唯一约束：unique(system, externalId)；unique(system, entityType, entityId)。
  索引：system+externalId 唯一；entityType+entityId；lastSyncedAt；status。

### CrmSyncJob（CRM 同步作业）

- id（UUID）
- system / scope（customers/suppliers/contacts/all）
- direction（push/pull/both）
- type（incremental/full）
- since（datetime 可空）
- status（pending/running/succeeded/failed）
- startedAt / finishedAt
- details（JSON：统计、错误列表）

索引：status；startedAt；finishedAt；system。

### Plan/SKU（套餐/产品）

- id（UUID）
- name / type（data/voice/sms/bundle）
- regions（列表）
- capacityMb / validityDays / retailPrice / wholesalePrice
- version / status（active/inactive）

索引：type；status；（regions）GIN。

### Pool（流量池）

- id（UUID）
- orgId（UUID）/ name
- quotaMb / usedMb / thresholdPercent
- autoScale（bool）/ scalePolicy（JSON）
- membersCount / subscriptions（JSON 列表或关联表）

索引：orgId；thresholdPercent。

### UsageRecord（用量记录）

- id（UUID）
- subscriptionId（FK）
- timestamp（datetime）
- dataUsedMb / voiceMin / smsCount
- source（CDR/Streaming/API）

索引：subscriptionId + timestamp（时间序列）；source。

### Order/OrderItem（订单）

- id（UUID）
- customerId（FK）/ status（created/processing/fulfilled/failed/cancelled）
- totalPrice / currency
- createdAt / fulfilledAt
- items（子表：planId、quantity、unitPrice、status）

索引：customerId；status；createdAt。

### Invoice（发票）

- id（UUID）
- customerId（FK）
- periodStart / periodEnd
- amount / tax / currency / status（created/reconciled/paid/void）
- approvalStatus（pending/approved/rejected）
- signStatus（unsigned/signed）
- reconciliationStatus（pending/succeeded/discrepancy）/ discrepancyCount
- approvedBy / approvedAt
- signedAt / signatureProvider / certificateRef
- reconciledAt
- pdfUrl / metadata

索引：customerId；periodStart/periodEnd；status。

### Payment（支付）

- id（UUID）
- invoiceId（FK）/ method（paypal/alipay/wechatpay/bank）
- amount / currency / status（initiated/succeeded/failed/refunded）
- gatewayRef / callbackPayload（JSON）
- payerBillNo（第三方账单编号/银行水单编号，可选）
- proofUrls（数组：支付截图/回单凭证的存储 URL/附件标识）
- receiptStatus（pending/confirmed/rejected）
- receiptConfirmedBy / receiptConfirmedAt / receiptNotes

索引：invoiceId；status；gatewayRef；receiptStatus；payerBillNo。

### Board（看板）

- id（UUID）
- name（唯一/项目内唯一）
- scopeType（project/team/productLine/channel/campaign/org）
- scopeRefId（可空，根据 scopeType 指向相应实体，如 projectId/teamId/campaignId）
- visibility（org/team/project/private）
- status（active/archived）
- wipPolicy（JSON：全局在制品限制、列间规则、自动化）
- swimlanes（JSON：按优先级/模块/负责人维度定义）
- metadata（JSON）

索引：scopeType+scopeRefId；status；name。

### BoardColumn（看板列）

- id（UUID）
- boardId（FK）
- key（slug，唯一于 boardId）
- name
- order（整数排序）
- wipLimit（整数，可空）
- policies（JSON：进入/离开规则、必填校验）
- isDone（bool，标记为完成态列）
- status（active/archived）

索引：boardId；order；isDone；key 唯一（于 board）。

### Task（任务/卡片）

- id（UUID）
- boardId（FK）/ columnId（FK）
- sprintId（FK 可空）
- type（task/bug/epic/ops/marketing）
- title / description（文本）
- assigneeId（FK: User，可空）
- priority（low/medium/high/urgent）
- labels（数组，GIN）
- storyPoints（数值，可空）
- estimateHours / remainingHours / actualHours（数值）
- status（open/in_progress/review/testing/done/cancelled）
- dueDate（datetime，可空）
- attachments（数组：fileId 列表，对接 /attachments）
- relatedInvoiceId / relatedPaymentId（FK 可空，用于与营收维度关联；或通过 labels/channel/campaign 进行弱关联）
- createdAt / updatedAt

索引：boardId；columnId；assigneeId；status；dueDate；labels（GIN）；priority；createdAt。

### Sprint（迭代）

- id（UUID）
- boardId（FK）
- name（唯一于 board）
- startDate / endDate / timezone
- workingCalendar（JSON：节假日/工作日定义）
- metricType（storyPoints/hours）
- plannedPoints（或 plannedHours）
- status（planned/active/closed）
- metadata（JSON）

索引：boardId；name；startDate；endDate；status。

### WorkLog（工时记录）

- id（UUID）
- taskId（FK）/ userId（FK）
- startAt / endAt / durationMinutes
- billable（bool）/ costCenter（可空）
- channel / campaignId（可空，用于与市场维度关联；也可由 task.labels 映射）
- note（文本）
- approvedStatus（pending/approved/rejected）/ approvedBy / approvedAt
- source（manual/timer/api/import）

索引：taskId；userId；startAt；approvedStatus；billable；campaignId。

### ReportSnapshot（报表快照）

- id（UUID）
- reportType（kanban_throughput/burndown/timesheet_summary/velocity/marketing_kpi_corr）
- periodStart / periodEnd
- boardId（FK 可空）/ sprintId（FK 可空）
- dimensions（JSON：project/team/module/label/channel/campaign 等维度）
- metrics（JSON：聚合指标，如 counts/avg/median/p95/velocity/wip 等）
- generatedAt / sourceVersion
- locked（bool）/ retentionUntil（datetime）

索引：reportType+periodStart+periodEnd；boardId；sprintId；generatedAt。

### MarketCrawlJob（市场数据抓取作业）

- id（UUID）
- platforms（数组：alibaba/jd/taobao/pinduoduo/amazon/ebay/shopee）
- status（pending/running/succeeded/failed）
- itemCount / startedAt / finishedAt
- params（JSON：categories/keywords/regions/maxItems/since/until）
- error（文本）

索引：status；startedAt；finishedAt。

### MarketCrawlItem（市场数据条目）

- id（UUID）
- jobId（FK）/ platform / productId
- title
- attributes（JSON：price/shipping/rating/salesVolume 等）
- bidInfo（JSON：当前竞价/出价/排名等）
- capturedAt（时间戳）

索引：jobId；platform；capturedAt。

### PricingStrategy（定价策略）

- id（UUID）
- name / description
- version（整数）/ status（draft/approved/published/retired）
- targetProducts（数组：产品 ID）
- rules（JSON）
- dataSourceJobId（FK -> MarketCrawlJob）
- effectiveFrom / effectiveTo
- channels（数组）
- approvedBy / approvedAt / publishNotes / publishedAt

索引：status；effectiveFrom/effectiveTo；dataSourceJobId；name。

### WebhookEvent（回调事件）

- id（UUID）
- source（smdpplus/operator/external）
- eventType（available/downloaded/installed/enabled/disabled/deleted/failed）
- payload（JSON）
- signature / receivedAt / processedAt / status（pending/succeeded/failed/deadletter）

索引：source；eventType；status；receivedAt。

### AuditLog（审计日志）

- id（UUID）
- actorId / actorType（user/service）
- action（create/update/delete/enable/disable/settle 等）
- resourceType / resourceId
- timestamp / result（success/fail）
- evidenceHash（不可篡改哈希）

索引：actorId；resourceType+resourceId；timestamp。

## 2. 关系与约束

- Operator 1..N ProfileType/Inventory；Operator 1..N Subscription；Operator 1..N ActivationCode。
- Customer 1..N Order；Customer 1..N Subscription；Customer 1..N Invoice。
- Order 1..N OrderItem；OrderItem 关联 Plan。
- Subscription 关联 ActivationCode（可空）、Plan、Customer、Operator。
- Pool 1..N Subscription（或多对多，通过关联表）。
- UsageRecord N..1 Subscription。
- Invoice N..1 Customer；Payment N..1 Invoice。

- Board 1..N BoardColumn；Board 1..N Task；Task N..1 BoardColumn；
- Sprint 1..N Task（Task.sprintId 可空）；Task 1..N WorkLog；
- ReportSnapshot 可选关联 Board/Sprint（面向报表维度）。
- Task 可选关联 Invoice/Payment（relatedInvoiceId/relatedPaymentId），用于研发/运营工作与财务票据、市场活动的关联分析。

- Supplier 1..N Contact；Customer 1..N Contact（isPrimary 约束每实体最多一个主联系人）。
- ExternalCrmBinding N..1 绑定到 Customer/Supplier/Contact；同一 system + externalId 只能指向一个本地实体。
- CrmSyncJob 与 ExternalCrmBinding、WebhookEvent 通过事件/日志关联，无强外键（便于归档与跨系统检索）。

## 3. 索引策略与性能

- 时间序列数据（UsageRecord）采用分区表或时序引擎（Timescale/ClickHouse），提升批量查询效率。
- 激活码与订阅主键与唯一约束严格校验，避免重复与脏写；启用幂等键。
- 订单与财务相关表采用聚簇索引优化报表检索；外键启用级联与软删除策略（审计留存）。
- 联系人与供应商：email、phone 建议增加唯一或部分唯一约束（按 entityId），避免重复；
- ExternalCrmBinding 需高并发匹配：建立（system, externalId）唯一索引与（entityType, entityId）辅助索引，支持双向查找；
- 同步作业（CrmSyncJob）按时间分区或归档策略管理历史，避免主表膨胀；

- 看板与任务：labels 建议使用 GIN 索引；优先对（boardId, columnId, status, assigneeId, dueDate）建立组合索引以优化筛选；
- 工时记录（WorkLog）：建议时间分区（按月/周）与（taskId, userId, startAt）索引；面向汇总的物化视图或快照（ReportSnapshot）用于加速历史查询；
- 燃尽与速度（Burndown/Velocity）：优先采用增量聚合与快照写入，避免实时重算高成本；

## 4. 数据安全与合规

- 敏感标识（EID/ICCID/IMSI/MSISDN）采用字段级加密与访问控制；审计所有访问。
- 数据留存策略：按法规与业务留存周期（如账务 ≥7 年，操作审计 ≥2 年，回调事件 ≥1 年）。
- 跨境与数据主权：按租户/区域进行数据隔离与驻留；跨区访问需审批与审计。
- 联系人 PII（email/phone/IM/社交账号）按 GDPR/数据隐私合规处理：最小化收集、加密存储、访问分级、脱敏导出；
- 外部 CRM 集成需遵守对方平台 API/数据使用政策，令牌与密钥存储在安全组件（Vault/HSM），并开启轮换与最小权限。
