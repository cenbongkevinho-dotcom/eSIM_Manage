# 技术架构补充：权限矩阵与错误处理/契约测试

本补充文档与《技术架构.md》配套，细化角色到OAuth scopes映射、错误处理策略与API契约测试实践，确保与《docs/api/openapi.yaml》与《docs/产品需求文档.md》一致。

## 权限矩阵与OAuth Scopes

- 角色到Scopes映射（与OpenAPI安全定义一致）：
  - Admin：suppliers:read/write、crm:read/write、integrations:write、billing:read、payments:read 等全量。
  - Operator Manager：suppliers:read、suppliers:write（限所属）、crm:read、integrations:write（限CRM沙盒）。
  - Sales/CS：crm:read、crm:write（联系人与客户主数据）、customers:read、orders:read。
  - Auditor：只读：crm:read、suppliers:read、billing:read、payments:read。

- 多租户隔离：所有数据访问必须携带租户上下文（tenantId），Scopes只能在租户边界内生效。
- PII 保护：按字段级策略脱敏（masking）与最小暴露；审计日志记录字段访问，保存≥13个月。
- 幂等与限流：写操作支持 Idempotency-Key；网关层/服务层双重限流与配额（配额可按租户与角色维度配置）。

## 错误处理与契约测试

- 错误模型：统一使用 ErrorResponse{code,message,details,requestId}；客户端必须处理4xx/5xx并带重试/退避策略。

- 重试策略：
  - 读请求：可立即重试（指数退避，最大3次）；
  - 写请求：配合 Idempotency-Key；对可重入的冲突返回409并提示客户端重试或刷新状态。

- API 契约测试：
  - 为关键端点（customers/suppliers/contacts/integrations）建立契约测试，校验 schemas 与示例；
  - Webhook事件签名校验与回调契约测试（含重试与幂等验证）。
    - 回调安全约定：请求头需包含 X-SMDP-Signature（签名）与 X-SMDP-Timestamp（时间戳）。
    - 推荐签名算法：HMAC-SHA256(secret, timestamp + body)；时间戳有效期默认 ≤ 5 分钟，超时或重放拒绝。
    - 契约测试校验：签名正确返回200，签名错误或过期返回401/403 + ErrorResponse；记录 requestId 便于审计。

- 兼容性策略：
  - 为每次API变更提供版本化（/v1,/v2 或 Accept-Version 头），提供弃用公告与迁移指南；
  - 使用 Consumer-Driven Contract（CDC）测试在CI管道中验证客户端与服务端兼容性。

## 契约测试覆盖计划与示例（新增）

- 测试工具建议：
  - 规范校验：OpenAPI 3.1 校验（openapi-cli / spectral）。
  - 合同测试：Dredd（基于 OpenAPI 的请求/响应对比）。
  - 模拟与对齐：Prism Mock Server（用于示例与前端联调）；Schemathesis（Python，基于 OpenAPI 的属性测试）。

- 覆盖范围（重点端点）：
  - /market/crawl-jobs（POST/GET）与 /market/crawl-jobs/{id}（GET）：常规 2xx/4xx 响应、统一 429（含 Retry-After）。
  - /pricing/strategies/{id}/simulate 与 /pricing/strategies/{id}/rollback：请求体 schema 校验（PricingStrategySimulationRequest/PricingStrategyRollbackRequest）、400 错误模型。
  - Webhook /webhooks/smdpplus：签名与时间戳请求头（X-SMDP-Signature/X-SMDP-Timestamp）校验；签名错误/过期返回 401/403。

- 关键断言项：
  - 统一错误模型：ErrorResponse 必含 requestId；错误码字典与 message 合理；details 字段可选但结构化。
  - 观察性头：响应包含 X-Correlation-ID；限流头包含 X-RateLimit-Limit/Remaining/Reset；限流触发含 Retry-After。
  - 幂等：对写操作在重复请求下响应一致（201→200 或 409），且不造成重复副作用；Idempotency-Key 作为请求头被记录。

- 示例（Python，验证 429 与 Retry-After）：
  1) 准备：将系统速率限制调低或在压测环境触发限流；
  2) 代码（示意）：
     - 发起对 /market/crawl-jobs 的高频请求，捕获 429。
     - 断言响应头包含 Retry-After 且为正整数秒；X-RateLimit-* 与 X-Correlation-ID 存在。
  3) 伪代码：
    - 请求多个并发：N=50；
    - 统计 429 数量与最小/最大 Retry-After；
    - 校验客户端在 Retry-After 后重试成功率 ≥ 95%。

- CI 集成建议：
  - 在合并与发布流程中执行规范校验与 Dredd/Schemathesis 契约测试；
  - 将限流与重试的契约测试标记为“可选”并在压测环境或夜间构建运行；
  - 合同测试结果（通过/失败与差异详情）纳入质量门槛，并生成报告归档（与审计要求对齐）。

## 监控与告警（与要求文档的指标一致）

- 指标：sync_throughput、success_rate、error_rate、latency_p50/p95、mapping_coverage、conflict_count、duplicate_merge_accuracy、connector_health。
- 告警：同步失败率超过阈值（默认>2%）、外部CRM速率限制触发、死信队列积压、幂等冲突异常。

## 路线图关联

- 在《docs/路线图.md》M2阶段完成：权限矩阵初版、错误模型统一、契约测试覆盖关键端点与Webhook回调。

## 新增：支付 Webhook 契约测试覆盖与示例

- 渠道与端点：
  - PayPal：POST /webhooks/payments/paypal（安全：验签头 PayPal-Transmission-Id/Time/Sig/Cert-Url/Auth-Algo）
  - 微信支付：POST /webhooks/payments/wechatpay（安全：Wechatpay-Timestamp/Nonce/Signature/Serial）
  - 支付宝：POST /webhooks/payments/alipay（安全：X-Alipay-Signature；实际签名字段在请求体 sign/sign_type）

- 验签与时效：
  - PayPal：按官方验签流程验证 Transmission-Sig，校验 webhook_id 与证书链（Cert-Url）；拒绝过期或证书不可信。
  - 微信支付：V3 签名验签（平台证书），resource 字段解密（AEAD_AES_256_GCM）；校验 Timestamp/Nonce 的时效窗口（默认 ≤5 分钟）。
  - 支付宝：RSA2 验签（sign/sign_type），校验通知时间与重复通知；支持时钟偏移容忍（±300秒）。

- 幂等与去重键：
  - PayPal：event.id 或 resource.id + event_type 作为幂等键。
  - 微信支付：解密后的交易号 transaction_id 或 out_trade_no + event_type。
  - 支付宝：notify_id 或 trade_no/out_trade_no + trade_status。

- 状态映射（统一到 Payment.status/receiptStatus）：
  - PayPal：PAYMENT.SALE.COMPLETED → success；PAYMENT.SALE.DENIED/REFUNDED → failed/refunded。
  - 微信支付：TRANSACTION.SUCCESS → success；TRANSACTION.CLOSED → failed；REFUND.SUCCESS → refunded。
  - 支付宝：TRADE_SUCCESS → success；WAIT_BUYER_PAY → pending；TRADE_CLOSED → failed；TRADE_FINISHED → success。

- 契约测试断言：
  - 200：验签通过、负载合法；服务端正确落库并返回 200。
  - 401：验签失败（签名错误/证书不匹配/过期/回放攻击）。
  - 400：负载结构不合法或缺少必要字段（如 event_type、resource、trade_status）。
  - 幂等：重复事件（同幂等键）返回 200 且不重复入账；日志包含 requestId 与幂等命中标记。
  - 对账关联：若能匹配到 invoiceId/payerBillNo，应更新 Payment.gatewayRef、status、receiptStatus 等；不可匹配时记录告警并返回 200（避免渠道重试风暴）。

- 用例矩阵（每渠道至少覆盖）：
  1) 正常事件：签名正确 + 合法负载 + 映射成功 → 200。
  2) 签名错误：变更签名或证书 → 401。
  3) 时间戳过期：超出 5 分钟窗口或重放 → 401。
  4) 重复事件：同幂等键重复回调 → 200（幂等命中，不重复入账）。
  5) 负载字段缺失：缺少 event_type/resource/trade_status → 400。
  6) 订单不匹配：无法关联 invoiceId/payerBillNo → 200（记录异常并人工介入）。
  7) 异常类型：未知 event_type → 400（可配置白名单与降级策略）。

- 示例（cURL 简化）：
  - PayPal：
    -H "PayPal-Transmission-Id: 123" -H "PayPal-Transmission-Time: 2025-10-29T10:00:00Z" -H "PayPal-Transmission-Sig: abc" 
    -d '{"id":"WH-1","event_type":"PAYMENT.SALE.COMPLETED","webhook_id":"WHID","resource_type":"sale","resource":{"id":"sale_001","state":"completed"}}'
  - 微信支付：
    -H "Wechatpay-Timestamp: 1730196000" -H "Wechatpay-Nonce: nonce" -H "Wechatpay-Signature: sig" 
    -d '{"id":"4200000","event_type":"TRANSACTION.SUCCESS","resource":{"algorithm":"AEAD_AES_256_GCM","ciphertext":"...","nonce":"n","associated_data":"payment"}}'
  - 支付宝：
    -H "X-Alipay-Signature: signxxx" 
    -d '{"out_trade_no":"inv_123","trade_no":"20251029001","trade_status":"TRADE_SUCCESS","total_amount":"199.00","buyer_id":"2088***","gmt_payment":"2025-10-29 18:00:00","sign":"xxx","sign_type":"RSA2"}'

- CI 集成与工具：
  - 使用 spectral/openapi-cli 校验 openapi.yaml；使用 Dredd 或 Schemathesis 进行契约测试；使用 Prism 模拟回调以便前端联调。
  - 在 CI 中将支付渠道契约测试纳入质量门槛，产出报告（包含通过/失败、差异、示例对比）并归档。

## 新增：看板/任务/工时/迭代/报表 Scopes 与契约测试覆盖

- 新增 OAuth Scopes（与 openapi.yaml 一致）：
  - boards:read / boards:write：看板与列的读取/管理。
  - tasks:read / tasks:write：任务读取/管理。
  - worklogs:read / worklogs:write：工时读取/记录与管理。
  - sprints:read / sprints:write：迭代读取/管理。
  - reports:read：报表与燃尽数据读取。

- 角色到 Scopes 参考映射（建议）：
  - Admin：上述全部 scopes。
  - Project Manager：boards:read/write、tasks:read/write、sprints:read/write、reports:read、worklogs:read。
  - Team Member：boards:read、tasks:read/write（限本人/所属团队）、worklogs:read/write（限本人）、sprints:read、reports:read。
  - Finance/Auditor：reports:read、worklogs:read、tasks:read（只读）、boards:read。

- 契约测试覆盖端点（与 OpenAPI 路径一致）：
  - /boards（GET/POST）：列表分页、创建看板（含 idempotency-key 与 201/200 幂等行为）。
  - /boards/{id}/columns（POST）：新增列，校验 BoardColumnCreate schema、204/201 行为与权限校验（boards:write）。
  - /tasks（GET/POST）：创建任务，校验 TaskCreate 字段（title、boardId、columnId、assignees、estimateSeconds、labels、priority 等）。
  - /worklogs（GET/POST）：记录工时，校验 WorkLogCreate（taskId、userId、seconds、startedAt、note）；限流与幂等键覆盖。
  - /sprints（GET/POST）：创建迭代，校验 SprintCreate（boardId、name、startDate/endDate、goal、velocityCap 等）。
  - /sprints/{id}/burndown（GET）：按 query 参数（granularity、tz）返回燃尽点序列（BurndownPoint[]）。
  - /reports（GET）：按 reportType 与 filters 生成快照（ReportSnapshot），校验 header 与错误模型一致性。

- 关键断言：
  - 安全与授权：无相应 scope 时返回 403；携带 scope 且资源越权（跨租户/跨团队）返回 403。
  - 幂等：对 POST 写操作，重复请求返回 201→200 或 409，且不重复副作用；Idempotency-Key 作为必检请求头。
  - 观察性头：响应统一包含 X-Correlation-ID；限流头 X-RateLimit-Limit/Remaining/Reset；触发限流返回 429 + Retry-After。
  - 错误模型：统一使用 ErrorResponse；字段完整（code,message,details,requestId）。
  - 过滤与分页：GET 列表支持 page/limit 与常用过滤（boardId、assigneeId、status、label、dateRange 等），返回总数与下一页游标（如适用）。

- 示例（Dredd/Schemathesis 契约测试配置要点）：
  - 为每个写端点提供示例请求体与期望响应（201/200），并在重复请求场景断言幂等行为；校验响应头包含 X-Correlation-ID 与限流头。
  - 为 /sprints/{id}/burndown 提供日期范围与 tz 的参数示例；断言返回的 points[].remainingSeconds 单调不增、时间序列按 granularity 递增。
  - 为 /worklogs 提供高频写入压测配置，在触发限流后断言 429 与 Retry-After 的可恢复重试路径。

- 与营收/支付维度的复用校验：
  - ReportSnapshot.filters 支持 marketId、campaignId、channel、currency 等维度；契约测试中提供示例 filters 并断言返回 snapshot 与 metadata 完整。
  - Task 与 WorkLog 的关联字段（campaignId、marketId、invoiceId）在示例中体现，并在 reports:read 下可读取聚合结果（不含敏感金额明细）。

- CI 集成：
  - 在 PR 合并前执行 openapi.yaml 的 lint 校验与 Dredd/Schemathesis 契约测试；对写端点的幂等与限流测试在夜间构建中执行。
  - 产出测试报告并归档到质量门户，报告中标明各端点通过率、失败差异、头部与错误模型一致性检查结果。
