# 契约测试与 OpenAPI 规范校验（CI 指南）

版本：v0.1  
最后更新：2025-10-29

目标：在 CI 中自动校验 docs/api/openapi.yaml 的规范一致性与关键端点的契约行为（示例可直接被 Dredd/Schemathesis 消费），并输出报告。

## 1. 工具与安装

- Node.js 工具：
  - @stoplight/spectral（OpenAPI Lint）
  - openapi-cli（可选）
- 契约测试：
  - Dredd（基于 OpenAPI 的请求/响应对比）
  - Schemathesis（基于 OpenAPI 的属性测试，Python）
- Mock（可选）：
  - Prism（OpenAPI Mock Server，便于前后端联调）

示例安装（本地或 CI 镜像）：

```bash
npm i -g @stoplight/spectral-cli openapi-cli dredd
python3 -m pip install --upgrade schemathesis
```

## 2. 路径与环境约定

- OpenAPI 文件：docs/api/openapi.yaml
- 令牌与请求头：
  - Authorization: Bearer ${TOKEN}
  - Idempotency-Key: ${IDEMPOTENCY_KEY}
  - X-Request-ID: ${REQUEST_ID}
- 基础 URL：通过环境变量 BASE_URL 注入（例如 https://api.esim-manage.example.com）。

## 3. Spectral 规范校验

```bash
spectral lint docs/api/openapi.yaml --fail-severity=warn
```

可选的规则定制：在 .spectral.yaml 中增加如下要点：

- 所有 4xx/5xx 响应必须引用统一错误模型（#/components/schemas/ErrorResponse）。
- GET 列表端点需包含分页参数 Page/PageSize 与示例 x-codeSamples。
- 触发限流的端点必须声明 429 并包含 Retry-After 头。

## 4. Dredd 契约测试

新增 dredd.yml（示例）：

```yaml
swagger: ./docs/api/openapi.yaml
endpoint: ${BASE_URL}
headers:
  Authorization: "Bearer ${TOKEN}"
  X-Request-ID: "${REQUEST_ID}"
color: true
``` 

执行：

```bash
REQUEST_ID=$(uuidgen)
TOKEN="<在 CI 中注入>"
BASE_URL="https://api.esim-manage.example.com"
IDEMPOTENCY_KEY=$(uuidgen)

# 运行核心端点（示例 OpenAPI 已含 x-codeSamples）
dredd ./docs/api/openapi.yaml ${BASE_URL} \
  --hookfiles=./docs/ci/hooks.js \
  --user "Authorization: Bearer ${TOKEN}" \
  --user "X-Request-ID: ${REQUEST_ID}" \
  --env IDEMPOTENCY_KEY=${IDEMPOTENCY_KEY}
```

可选 hooks（docs/ci/hooks.js）：设置幂等键/租户头，或在限流场景下退避重试（示意）。

## 5. Schemathesis（属性测试）

示例：仅覆盖项目管理相关端点（boards/tasks/worklogs/sprints/reports），并验证 2xx/4xx/429 的头与错误模型。

```bash
schemathesis run docs/api/openapi.yaml \
  --base-url=${BASE_URL} \
  --tag boards --tag tasks --tag worklogs --tag sprints --tag reports \
  --checks all \
  --hypothesis-max-examples=100 \
  --concurrency=4 \
  --auth="Bearer ${TOKEN}" \
  --header="X-Request-ID: ${REQUEST_ID}" \
  --exclude-deprecated
```

断言要点：
- 响应包含 X-Correlation-ID；429 包含 Retry-After 与 X-RateLimit-*；错误响应为 ErrorResponse。
- POST 幂等：相同 Idempotency-Key 的重复请求不产生重复副作用（可在 hooks 中注入）。

## 6. GitHub Actions 集成（示例）

新增 .github/workflows/contract-tests.yml（示意配置）：

```yaml
name: Contract Tests
on:
  pull_request:
    paths:
      - 'docs/api/openapi.yaml'
      - 'docs/错误码字典.md'
      - 'docs/技术架构_权限矩阵与契约测试.md'

jobs:
  spectral:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm i -g @stoplight/spectral-cli
      - run: spectral lint docs/api/openapi.yaml --fail-severity=warn

  dredd:
    runs-on: ubuntu-latest
    needs: spectral
    steps:
      - uses: actions/checkout@v4
      - run: |
          npm i -g dredd
          REQUEST_ID=$(uuidgen)
          IDEMPOTENCY_KEY=$(uuidgen)
          dredd ./docs/api/openapi.yaml ${{ secrets.BASE_URL }} \
            --user "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            --user "X-Request-ID: ${REQUEST_ID}" \
            --env IDEMPOTENCY_KEY=${IDEMPOTENCY_KEY}

  schemathesis:
    runs-on: ubuntu-latest
    needs: spectral
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: |
          pip install schemathesis
          REQUEST_ID=$(uuidgen)
          schemathesis run docs/api/openapi.yaml \
            --base-url=${{ secrets.BASE_URL }} \
            --tag boards --tag tasks --tag worklogs --tag sprints --tag reports \
            --checks all \
            --hypothesis-max-examples=50 \
            --auth="Bearer ${{ secrets.API_TOKEN }}" \
            --header="X-Request-ID: ${REQUEST_ID}"
```

注意：
- secrets.BASE_URL / secrets.API_TOKEN 需在仓库或组织层面配置。
- 在压测环境中执行限流相关用例，避免对生产或共享开发环境造成影响。

## 7. 报告与门槛

- Lint 无严重错误（error）；警告（warn）数量逐步降低到 ≤ 5 条。
- 契约测试通过率 ≥ 95%；所有关键端点（POST/GET/429/401/400 路径）必须通过。
- 失败详情与差异报告上传至制品库或质量门户，便于审计与回归。

## 8. 变更约束

- 修改 openapi.yaml 时，必须同步更新示例（x-codeSamples）、externalDocs 指向（docs/错误码字典.md）与新增/变更的 schemas；
- 在 PR 描述中附带变更摘要与契约测试结果链接。

