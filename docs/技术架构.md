# eSIM_Manage 系统技术架构与语言开发文档

版本：v0.1（草案）  
状态：进行中  
最后更新：2025-10-29
项目性质：企业内部项目，不对外公开；接口仅用于内网调用与契约测试。

## 1. 架构目标

- 满足 GSMA eSIM RSP（Consumer/M2M）对接要求，支持 SM-DP+/SM-DS（以及可扩展至 SM-DP/SM-SR）。
- 面向多租户（运营商、渠道、企业）的高可用微服务架构，保证安全、可观测、可扩展。
- 支持批量与高并发激活、可靠的事件驱动，具备强幂等与审计能力。
- 架构风格：B/S（Browser/Server），前端基于 React/Next.js，后端服务通过 API 网关统一暴露。

## 2. 技术选型与开发语言

- 后端：Go + Python（微服务组合）
  - Go：高并发网络 I/O、服务编排、API 网关/鉴权与核心服务（订单/订阅/计费），静态编译、易部署。
  - Python：数据处理与分析（市场抓取、定价仿真/A-B、ETL）、任务编排（Celery/Airflow），生态丰富。
  - 分工与优势：Go 负责低延迟与可观察性友好的核心交易路径；Python 负责算法/数据密集型任务与快速迭代。两者通过 gRPC/REST/Kafka 互通。
- API 网关：Kong / NGINX（支持 mTLS、限流、熔断、路径转发、审计插件）。
- 消息与事件：Apache Kafka（事件总线），Debezium（Outbox/CDC）确保跨服务一致性。
- 数据存储：
  - PostgreSQL（核心交易与配置数据，主从与读写分离）；Flyway 做版本迁移。
  - Redis（缓存、分布式锁、幂等键与会话存储）。
  - ClickHouse 或 TimescaleDB（时序/用量与报表）；可选 Elasticsearch（全文与检索）。
  - 对象存储（S3/MinIO）：二维码图片、报表导出与归档。
- 前端：React + Next.js（SSR/SSG），UI 组件库（Ant Design），i18n 支持。
- 鉴权与身份：Keycloak（OIDC/OAuth2，RBAC/ABAC），支持多租户与 SSO。
- 观察与运维：Prometheus + Grafana（指标），ELK/ Loki（日志），OpenTelemetry（Trace）。
- 部署：Docker + Kubernetes（多副本、滚动升级、蓝绿/金丝雀发布）。
- 密钥与证书：HashiCorp Vault（PKI/证书签发与轮换），可对接 HSM。

## 3. 系统组件与职责

- API Gateway：统一入口，mTLS、鉴权、限流、审计；暴露 REST/gRPC。
- Auth Service：租户、用户、角色与权限；OAuth2/OIDC/OAuth Client 管理。
- Carrier Integration Service：
  - 对接运营商 SM-DP+/SM-DS（Consumer）与可扩展的 SM-DP/SM-SR（M2M）。
  - 管理证书、端点、价目表、库存同步与 SLA 指标。
  - Webhook 接收与状态机驱动（Profile 状态变更）。
- Provisioning Service：
  - 激活码生成与分发（二维码/链接），LPA 流程配合；匹配 EID 与 MatchingID。
  - 订阅生命周期：下载/安装/启用/停用/删除；强幂等与回退。
- Catalog & Plan Service：套餐、产品、组合包、促销策略与上架管理。
- Pool & Usage Service：企业流量池、配额、阈值告警、预测与自动扩容。
- Order Service：订单创建、拆解与履约，异常重试与人工介入。
- Billing & Invoice Service：用量采集、资费规则、发票生成、税务与汇率处理。
- Payment & Settlement Service：支付网关、对账、渠道与运营商结算与分润。
- Analytics & Pricing Service：竞价策略、动态定价、仿真与 A/B 测试。
- Notification Service：邮件/短信/站内通知与模版管理。
- Support & Ticket Service：工单流转、知识库、RCA 与回访。
- Audit & Compliance Service：不可篡改审计、数据留存策略与法规接口。
- CRM & Master Data Service：客户/供应商主数据、联系人管理；外部 CRM 集成（Salesforce/HubSpot/Zoho 等），字段映射与冲突策略；同步作业编排与审计。

## 4. 领域数据模型（概览）

- Operator（运营商）：名称、端点、证书、区域、价目表、SLA。
- ProfileType/Inventory：区域、有效期、容量、成本、可用库存与状态机。
- ActivationCode：编码、二维码、状态（可用/已使用/作废）、过期时间、绑定关系。
- Subscription（订阅）：EID、ICCID、IMSI、MSISDN、状态（创建/下载/安装/启用/停用/删除）、关联客户/套餐/订单。
- Customer/Account：B2B/B2C、KYC、联系人与账期。
- Order/OrderItem：产品行、价格、履约状态、异常与重试次数。
- Plan/Catalog/SKU：属性、适用区域、版本、促销与渠道差异化。
- Pool：组织/项目维度的配额与使用统计、阈值与自动扩容策略。
- UsageRecord：时间序列用量数据（数据/语音/短信），来源与校验。
- Invoice/Payment/Settlement：金额、税率、币种、状态与对账流水。
- WebhookEvent：来源、事件类型、payload、处理状态与死信/重试。
- AuditLog：操作主体、对象、动作、时间、结果、证据（签名哈希）。

详见 docs/数据模型.md。

## 5. 接口设计与安全

- 风格：REST（对外） + gRPC（内部）。统一错误码与幂等键（Idempotency-Key）。
- 安全：
  - mTLS（对运营商与敏感内部服务），TLS1.2+，强密码套件与证书轮换。
  - OAuth2/OIDC（第三方应用、渠道商），Scopes 与细粒度权限校验。
  - 请求签名与重放防护（时间戳 + nonce）；速率限制与 WAF。
  - 敏感数据加密存储（EID、匹配信息、证书密钥引用 Vault/HSM）。
- Webhook：可靠投递（重试、签名、死信队列），有序处理与去重。

## 6. 事件驱动与一致性

- 事件总线：Kafka 主题按领域划分（订单、订阅、计费、Webhook 等）。
- Outbox/CDC：事务性事件发布，避免双写不一致；消费者端幂等处理。
- Saga/补偿：跨服务业务流程采用 Saga，失败时触发补偿动作（如撤销激活码）。

## 7. 部署与环境

- 环境划分：Dev / Staging / Prod；独立租户与密钥空间。
- 部署策略：滚动、蓝绿/金丝雀；灰度发布与健康检查；自动回滚。
- 配置与密钥：Helm/Kustomize 管理，Vault 下发；证书自动化（ACME/内部 CA）。
- 监控与告警：SLA 指标、队列积压、失败率、库存阈值与财务异常告警。

## 8. 开发流程与质量保障

- Git 工作流：main（发布）/ develop（集成）/ feature 分支；PR 评审与语义化版本。
- 代码质量：静态扫描（SAST）、依赖漏洞扫描（SCA）、单元/集成/契约测试。
- 性能测试：激活峰值并发场景压测（带 Webhook 回调链路），P95_latency 与错误率达标。
- 安全演练：渗透测试、证书过期与轮换演练、灾备切换演练。

## 9. 参考接口（OpenAPI 摘要）

详见 docs/api/openapi.yaml。主要资源：

- /operators、/plans、/pools、/customers、/orders、/subscriptions、/activation-codes、/billing/invoices、/payments、/webhooks/smdpplus、/suppliers、/crm/contacts、/integrations/crm、/integrations/crm/sync。

## 10. 示例流程与伪代码

注：以下示例为语言无关的逻辑演示，实际实现采用 Go/Python。

### 10.1 激活码生成（简化伪代码）

```go
// 输入：operatorId, planId, customerId
// 输出：ActivationCode（包含 LPA 字符串与二维码）

type ActivationCode struct {
    LPA     string
    QRCode  string
}

func GenerateCode(operatorId, planId, customerId string) (*ActivationCode, error) {
    op, err := operatorRepo.Find(operatorId)
    if err != nil { return nil, err }
    smdpAddress := op.SmdpPlusAddress
    matchingId := idGenerator.NewMatchingId()
    lpa := fmt.Sprintf("LPA:1$%s$%s$%s", smdpAddress, matchingId, "OPTS")
    qrcode, err := qrService.Encode(lpa)
    if err != nil { return nil, err }
    return activationCodeRepo.Save(&ActivationCode{LPA: lpa, QRCode: qrcode})
}
```

```python
# 输入：operator_id, plan_id, customer_id
# 输出：ActivationCode（包含 LPA 字符串与二维码）

from dataclasses import dataclass

@dataclass
class ActivationCode:
    lpa: str
    qrcode: str

def generate_code(operator_id: str, plan_id: str, customer_id: str) -> ActivationCode:
    op = operator_repo.find(operator_id)
    smdp_address = op.smdp_plus_address
    matching_id = id_generator.new_matching_id()
    lpa = f"LPA:1${smdp_address}${matching_id}$OPTS"
    qrcode = qr_service.encode(lpa)
    return activation_code_repo.save(ActivationCode(lpa=lpa, qrcode=qrcode))
```

### 10.2 Webhook 处理（简化伪代码）

```go
// 输入：SM-DP+ Webhook payload
// 功能：更新订阅状态、发布事件与触发履约/计费联动

type Event struct {
    Status string
    // ... 其他字段
}

func HandleWebhook(e Event) error {
    if err := verifySignature(e); err != nil { return err }
    sub, err := findByEidOrIccid(e)
    if err != nil { return err }
    sub.ApplyStateTransition(e.Status)
    if err := repo.Save(sub); err != nil { return err }
    return kafka.Publish("subscription.events", e)
}
```

```python
# 输入：SM-DP+ Webhook payload
# 功能：更新订阅状态、发布事件与触发履约/计费联动

class Event:
    def __init__(self, status: str, **kwargs):
        self.status = status
        # ... 其他字段

def handle_webhook(event: Event) -> None:
    verify_signature(event)
    sub = find_by_eid_or_iccid(event)
    sub.apply_state_transition(event.status)
    repo.save(sub)
    kafka.publish("subscription.events", event)
```

## 11. 安全与合规清单（概要）

- mTLS、证书轮换、密钥最小化暴露，Vault 审计开启。
- 审计日志不可篡改（WORM 存储/带哈希签名），操作留痕与追责。
- 隐私与数据主权合规（GDPR/CCPA/本地法规），跨境传输控制与数据驻留策略。
- 融合渗透测试与安全基线，定期修复漏洞与更新依赖。

## 12. 附录

- 运营商对接差异清单（字段映射、错误码、流程差异）。
- SLA 指标定义（成功率、延迟、库存、Webhook 可靠性）。

## 13. 外部 CRM 连接器与同步策略（新增）

### 13.1 集成模式

- 认证：OAuth2 客户端凭据或授权码流（平台作为集成应用）；令牌与密钥存储于 Vault，开启轮换与最小权限。
- 连接：REST API（官方 SDK 可选）；支持 Webhook（外部事件推送）与轮询（增量变更拉取）。
- 限流与重试：遵循外部平台 Rate Limit，指数退避与熔断；失败入死信队列（DLQ），人工/自动重试。

### 13.2 同步模型

- 方向：one_way（平台 → 外部或外部 → 平台）/ two_way（双向）。
- 范围：customers / suppliers / contacts / all；类型：incremental（按更新时间戳/变更流）/ full（按快照）。
- 锚点：ExternalCrmBinding 维护 externalId 与 lastSyncedAt；无匹配时采用去重规则（按邮箱/电话/名称 + 模糊匹配），新建或合并。
- 幂等：
  - 作业级：CrmSyncJob 使用 jobId 作为幂等键；
  - 记录级：按（system, externalId）或（entityType, entityId）作为幂等键，避免重复更新。

### 13.3 字段映射与冲突策略

- 字段映射：在 ExternalCrmBinding.fieldMappings 存储映射快照（版本化），支持多租户自定义。
- 冲突策略：platform_first / external_first / field_level（按字段 LastUpdated 优先级）；审计差异并提供审批流。
- 转换规则：规范化电话/邮箱、地址与税号；清洗无效字符与编码；国际化（语言/时区）。

### 13.4 观测与指标（建议）

- 同步吞吐（records/sec）、成功率、错误率（4xx/5xx/业务冲突）、延迟分位（P95/P99）。
- 映射覆盖率与冲突数量；重复记录合并率；Webhook 投递可靠性。
- 仪表盘：按系统/租户/实体类型分层展示，告警阈值可配置。

### 13.5 安全与合规

- PII（联系人邮箱/电话/IM）加密存储与访问分级；日志脱敏；按 GDPR/CCPA 合规留存与删除（Right to be Forgotten）。
- 外部平台政策合规：API 使用条款、数据共享限制；审计所有读取/写入与令牌使用。

### 13.6 失败处理与回滚

- 局部失败回滚：按记录记账，失败重试不影响已成功的批次；
- 任务恢复：支持断点续传（since 标记），超限暂停并通知运维；
- 手动干预：提供对账视图与差异比对工具，支持手动合并与标记忽略。

## 14. 内部项目管理与报表（看板/任务/工时/迭代/燃尽）

本章节定义研发与交付过程的内部项目管理子系统，涵盖看板（Board/Column）、任务（Task）、工时（WorkLog）、迭代（Sprint）与报表（ReportSnapshot），与主业务无强耦合，通过统一鉴权与事件总线实现扩展与复用（例如与市场/营收维度的关联分析）。

### 14.1 模块与职责

- Board Service：看板/列管理，WIP（在制品）规则、泳道配置与可见性控制（org/team/project/private）。
- Task Service：卡片生命周期（open → in_progress → review/testing → done/cancelled），估时与实际用时、标签、优先级、附件；支持与迭代关联。
- WorkLog Service：工时记录（手动/计时器/API/导入），计费标记与审核流（approved/pending/rejected）。
- Sprint Service：迭代计划/激活/关闭，工作日历（节假日/工作日）与度量类型（storyPoints/hours）。
- Report Service：通量/燃尽/速度/工时汇总等报表快照的生成与查询；支持维度化（project/team/module/label/channel/campaign）。

接口摘要参见 docs/api/openapi.yaml：/boards、/boards/{id}/columns、/tasks、/worklogs、/sprints、/sprints/{id}/burndown、/reports。

### 14.2 数据流与事件

- 事件主题（Kafka）：
  - project.board.created / project.board.column.created
  - project.task.created / project.task.updated / project.task.moved / project.task.done
  - project.worklog.created / project.worklog.approved
  - project.sprint.created / project.sprint.activated / project.sprint.closed
  - project.report.snapshot.generated
- Outbox/CDC：各服务将领域事件作为事务性消息写入 Outbox，Debezium 发布至 Kafka；消费者侧幂等（按 eventId 或资源版本）。
- 报表生成：
  - 增量聚合：任务状态变更与工时新增事件触发对应维度的累加与快照刷新。
  - 定时作业：每日/每小时生成指定看板/迭代的快照，落地至 ReportSnapshot 以供查询与导出。

### 14.3 存储与索引

- 主存储：PostgreSQL（Board/Column/Task/Sprint/WorkLog/ReportSnapshot），详见 docs/数据模型.md。
- 时序/分析引擎：ClickHouse 或 TimescaleDB（可选）用于长期历史与高维度聚合；提供物化视图加速（如工时分桶、燃尽日维度）。
- 索引建议：
  - Task：GIN(labels)，组合索引（boardId, columnId, status, assigneeId, dueDate）。
  - WorkLog：时间分区（按月/周），索引（taskId, userId, startAt）。
  - ReportSnapshot：唯一键（type + periodStart + periodEnd + 维度），便于去重与更新。

### 14.4 报表与燃尽算法

- 看板通量（Kanban Throughput）：
  - 指标：itemsCompleted、avgCycleTimeHours、wipCount、按标签/负责人分段统计。
  - 周期：按日/周/月生成；Cycle Time 计算为卡片首次进入 in_progress 至进入 isDone 列的时间差（支持暂停/阻塞时间剔除）。
- 燃尽（Burndown）：
  - 输入：Sprint(metricType=hours/storyPoints)、Task(estimateHours/storyPoints、status、dueDate)、WorkLog(actualHours)。
  - 规则：按 Sprint 工作日历生成日期桶；remaining = planned - sum(done by date)；排除非工作日；支持 scope 变更（新增/移出任务）作为事件记录并在曲线中体现。
- 速度（Velocity）：
  - 近 N 个迭代的完成量均值/中位数（storyPoints/hours）；支持异常值截断与节假日归一化。
- 工时汇总（Timesheet Summary）：
  - 维度：user/project/team/label/channel/campaign；指标：sum(durationMinutes)、billableRatio、approvedRatio。

### 14.5 安全、权限与速率限制

- 鉴权：Keycloak（OIDC/OAuth2）。Scopes：boards:read/write、tasks:read/write、worklogs:read/write、sprints:read/write、reports:read；RBAC/ABAC（按租户/项目/团队）。
- 幂等：POST 创建接口使用 Idempotency-Key；服务端以（tenantId, route, idemKey）建立幂等键，超时保留窗口（如 24h）。
- 速率限制：在 API 网关与服务层对读取与创建分别设置配额；接口返回 429（含 Retry-After 与 RateLimit 头）。
- 审计：所有写操作写入 AuditLog（actor、resource、action、result、evidenceHash）。

### 14.6 可观测性与契约测试

- 头部：X-Request-ID（入参）、X-Correlation-ID（响应）、OpenTelemetry TraceContext 透传（traceparent）。
- 指标：
  - 请求延迟/错误率（P95/P99）、各端点吞吐与配额消耗；工时审批率、燃尽偏差（实际 vs 计划）。
- 日志：结构化日志，敏感信息脱敏；错误使用统一模型（docs/错误码字典.md），OpenAPI 通过 externalDocs 链接指向字典。
- 契约测试：
  - Dredd/Schemathesis 针对 /boards、/tasks、/worklogs、/sprints、/reports 端点进行覆盖，含安全声明、示例请求体、429/400/401 错误路径与观察性断言（头部）。
  - CI 集成：在 PR 中自动运行 Spectral（规范静态检查）与 Dredd/Schemathesis（运行时契约），变更 OpenAPI 必须更新示例与字典。

### 14.7 与主业务的复用与隔离

- 复用：
  - 通过 Task.labels 或 WorkLog.channel/campaignId 与市场/营收维度建立弱关联，用于跨域报表（如研发投入与渠道转化相关性）。
- 隔离：
  - 与主交易路径解耦，采用独立数据库 schema 与主题前缀（project.\*）；关键路径不受项目管理子系统故障影响。

### 14.8 风险与治理

- 数据一致性：跨服务写入采用 Saga/补偿；导入/批量操作启用幂等与去重策略。
- 合规：工时与审批记录受审计合规约束；报表导出需脱敏与权限校验。
- 性能：大规模工时与任务历史建议按期归档与快照；查询接口默认分页与筛选限制，避免全表扫描。

## 15. 国际化与多语言（i18n）技术方案（新增）

本章节定义管理台的多语言实现方案与规范。当前管理台框架为 Vue 3 + Element Plus；i18n 实现基于 vue-i18n v9。若后续采用 React/Next.js，则可对应替换为 i18next，但键命名与流程约定保持一致。

### 15.1 总览与目标

- 目标：提供 zh-CN 与 en-US 两种语言的完整支持，覆盖 UI 文案、校验信息、导出标签与格式化（金额、数字、日期时间）。
- 要点：统一键命名、懒加载语言包、语言协商与持久化、Element Plus 语言包联动、缺失键检测。

### 15.2 资源组织与键规范

- 目录结构（前端项目）：
  - src/locales/zh-CN.ts
  - src/locales/en-US.ts
  - src/plugins/i18n.ts（初始化与工具函数）
- 键命名：module.submodule.semantic 三段式，如：
  - common.ok、common.cancel、common.back、common.backTop
  - layout.logout、layout.openSettings、layout.user
  - invoice.detail.title、invoice.actions.approve、invoice.actions.downloadPdf
  - subscription.detail.title、subscription.detail.back
- 约束：禁止在代码中硬编码中文/英文；所有可见文案必须通过 $t('key') 渲染。

### 15.3 vue-i18n 初始化（示例）

```ts
// src/plugins/i18n.ts
import { createI18n } from "vue-i18n";
import zhCN from "@/locales/zh-CN";
import enUS from "@/locales/en-US";

// 获取初始语言：查询参数 > 用户配置 > 本地存储 > 浏览器语言 > 默认 zh-CN
function resolveInitialLocale(): string {
  const urlLang = new URL(location.href).searchParams.get("lang");
  const stored = localStorage.getItem("locale");
  const browser = navigator.language?.toLowerCase();
  const preferred = urlLang || stored || (browser?.includes("en") ? "en-US" : "zh-CN");
  return preferred;
}

export const i18n = createI18n({
  legacy: false,
  globalInjection: true,
  locale: resolveInitialLocale(),
  fallbackLocale: "zh-CN",
  messages: {
    "zh-CN": zhCN,
    "en-US": enUS
  }
});
```

### 15.4 语言协商与持久化

- 协商优先级：URL ?lang > 用户配置（profile）> 本地存储（localStorage.locale）> 浏览器语言 > 默认 zh-CN。
- 切换：在导航栏提供语言下拉，切换后 i18n.global.locale.value 赋新值并写入 localStorage；同时联动 Element Plus 语言包。

### 15.5 懒加载与体积控制

- 对于大型页面或第三方模块的专用文案，可拆分子包并按路由懒加载：
  - import(/* webpackChunkName: "locale-en-invoice" */ '@/locales/en-US/invoice')。
- 首屏仅加载通用与核心模块文案，保证增量体积 ≤ 5%。

### 15.6 格式化（金额/数字/日期时间）

- 使用 Intl.NumberFormat 与 Intl.DateTimeFormat，按语言与地区格式化：
  - 货币：new Intl.NumberFormat(locale, { style: 'currency', currency }).format(amount)
  - 百分比与小数位：new Intl.NumberFormat(locale, { maximumFractionDigits: 2 })
  - 日期时间：new Intl.DateTimeFormat(locale, opts).format(date)
- 时区：根据用户偏好与浏览器自动推断（Intl.DateTimeFormat 支持 timeZone 参数）。导出文件需记录生成时区。

### 15.7 Element Plus 语言包联动

- 根组件通过 <el-config-provider :locale="currentLocale"> 包裹，currentLocale 随 i18n.locale 切换：
  - zh-cn：import zhCn from 'element-plus/es/locale/lang/zh-cn'
  - en：import en from 'element-plus/es/locale/lang/en'
- 切换语言时同时切换 currentLocale，确保日期选择器、分页等组件文案同步更新。

### 15.8 语言切换组件（示意）

```vue
<script setup lang="ts">
import { computed } from 'vue';
import { useI18n } from 'vue-i18n';
import zhCn from 'element-plus/es/locale/lang/zh-cn';
import en from 'element-plus/es/locale/lang/en';

const { locale, t } = useI18n();
const currentEpLocale = computed(() => (locale.value === 'en-US' ? en : zhCn));

function switchLocale(lang: 'zh-CN' | 'en-US') {
  locale.value = lang;
  localStorage.setItem('locale', lang);
}
</script>

<template>
  <el-dropdown trigger="click">
    <span class="el-dropdown-link">{{ t('layout.language') }}</span>
    <template #dropdown>
      <el-dropdown-menu>
        <el-dropdown-item @click="switchLocale('zh-CN')">中文</el-dropdown-item>
        <el-dropdown-item @click="switchLocale('en-US')">English</el-dropdown-item>
      </el-dropdown-menu>
    </template>
  </el-dropdown>
</template>
```

### 15.9 缺失键检测与 CI

- 在构建或 CI 中增加脚本，扫描 src/views 与 src/components 的 $t('...') 引用，核对 locales 键是否存在；对缺失键发出警告或阻断（可配置阈值）。
- Lint 规则：禁止硬编码中文/英文（允许极少数技术术语）。

### 15.10 迁移与覆盖计划

- 首期优先覆盖：布局导航、订阅详情、发票详情等用户直接操作的页面与对话框。
- 后续逐步覆盖：系统设置、报表、运营商接入向导与通知模版。
- 文案评审：新增页面需同时提交中英文文案 PR，并通过评审后合入。
